apiVersion: apps/v1
kind: Deployment
metadata:
  name: deepseek-r1-exclusive
  namespace: llm-testing
spec:
  replicas: 1
  selector:
    matchLabels:
      app: deepseek-r1-exclusive
  template:
    metadata:
      labels:
        app: deepseek-r1-exclusive
    spec:
      containers:
      - name: deepseek
        image: ghcr.io/huggingface/text-generation-inference:3.3.4
        args:
        - "--model-id"
        - "deepseek-ai/DeepSeek-R1-Distill-Llama-8B"
        - "--port"
        - "80"
        - "--max-input-length"
        - "512"
        - "--max-total-tokens"
        - "1024"
        - "--max-batch-prefill-tokens"
        - "8192"
        - "--max-batch-total-tokens"
        - "16384"
        - "--cuda-memory-fraction"
        - "0.9"
        - "--max-concurrent-requests"
        - "32"
        - "--max-waiting-tokens"
        - "10"
        ports:
        - containerPort: 80
        env:
        - name: PYTORCH_CUDA_ALLOC_CONF
          value: "expandable_segments:True"
        resources:
          limits:
            nvidia.com/gpu: 1
            memory: 16Gi
          requests:
            memory: 8Gi
            nvidia.com/gpu: 1
        securityContext:
          capabilities:
            add: ["SYS_NICE"]
        volumeMounts:
        - name: cache-volume
          mountPath: /data
        - name: shm-volume
          mountPath: /dev/shm
      nodeSelector:
        eks-node: gpu-exclusive
      volumes:
      - name: cache-volume
        emptyDir: {}
      - name: shm-volume
        emptyDir:
          medium: Memory
          sizeLimit: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: deepseek-r1-exclusive-service
  namespace: llm-testing
spec:
  selector:
    app: deepseek-r1-exclusive
  ports:
  - port: 8080
    targetPort: 80
  type: ClusterIP
